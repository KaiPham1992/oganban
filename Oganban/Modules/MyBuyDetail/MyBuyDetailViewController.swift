//
//  MyBuyDetailViewController.swift
//  Oganban
//
//  Created Kai Pham on 1/6/19.
//  Copyright © 2019 Coby. All rights reserved.
//
//  Template generated by Juanpe Catalán @JuanpeCMiOS
//

import UIKit

enum MyBuyType: Int {
    case infoProduct = 0
    case infoSaler
}

class MyBuyDetailViewController: BaseViewController {

	var presenter: MyBuyDetailPresenterProtocol?
    var listHeader = ["Chi tiết", "Thông tin người bán"]
    
    var order: OrderDetailEntity? {
        didSet {
            guard let _order = order else { return }
            tbDetail.reloadData()
            
            // BUYER
            if !isSaler {
                vControlSaler.isHidden = true
                vDoneNotArrived.isHidden = _order.getStatus() != .waitDelivery
                
                if _order.getStatus() == .done || _order.getStatus() == .cancel {
                    vContainerRating.isHidden = false
                } else {
                    vContainerRating.isHidden = true
                }
                // SALER
            } else {
                vControlSaler.isHidden = false
                // accep
                vAcceptCancel.isHidden = _order.getStatus() != .new
                
                // rating
                if _order.getStatus() == .done || _order.getStatus() == .cancel {
                    vContainerRatingSaler.isHidden = false
                } else {
                    vContainerRatingSaler.isHidden = true
                }
                
                // receive money
                if _order.paymentType == "cash" && _order.getStatus() == .waitDelivery {
                    vReceivedMoney.isHidden = false
                } else {
                    vReceivedMoney.isHidden = true
                }
                
            }
            
        }
    }
    
    var orderId: String = ""
    var isSaler = true

     @IBOutlet weak var tbDetail: UITableView!
    // buyer
    @IBOutlet weak var vDoneNotArrived: UIView!
    @IBOutlet weak var vRating: AppRatingView!
    @IBOutlet weak var vContainerRating: UIView!
    
    // saller
    @IBOutlet weak var vControlSaler: UIView!
    @IBOutlet weak var vAcceptCancel: UIView!
    @IBOutlet weak var vRatingSaler: AppRatingView!
    @IBOutlet weak var vContainerRatingSaler: UIView!
    @IBOutlet weak var vReceivedMoney: UIView!
    
	override func viewDidLoad() {
        super.viewDidLoad()
        
        presenter?.getDetailOrder(id: orderId)
        configureTable()
    }
    
    override func setUpNavigation() {
        super.setUpNavigation()
        addBackToNavigation()
        setTitleNavigation(title: "Chi tiết đơn hàng")
    }
    
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        hideTabbar()
    }

}

extension MyBuyDetailViewController: MyBuyDetailViewProtocol {
    func didGetOrder(order: OrderDetailEntity?) {
        self.order = order
    }
    
    func didPostRating(data: BaseResponse?) {
        self.pop()
    }
}


// MARK: table
extension MyBuyDetailViewController: UITableViewDelegate, UITableViewDataSource {
    func configureTable() {
        tbDetail.delegate = self
        tbDetail.dataSource = self
        tbDetail.registerXibFile(MyBuyImageCell.self)
        tbDetail.registerXibFile(MyBuyInfoUserCell.self)
        
        tbDetail.separatorStyle = .none
        tbDetail.rowHeight = UITableView.automaticDimension
        tbDetail.estimatedRowHeight = 150
    }
    
    func numberOfSections(in tableView: UITableView) -> Int {
        return listHeader.count
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        
        switch indexPath.section {
        case OrderDetailInfoType.infoProduct.rawValue:
            let cell = tbDetail.dequeue(MyBuyImageCell.self, for: indexPath)
            cell.setData(order: self.order, isSaler: self.isSaler)
            cell.delegate = self
            return cell
        default:
            let cell = tbDetail.dequeue(MyBuyInfoUserCell.self, for: indexPath)
            cell.recordMyBuy = self.order
            return cell
        }
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return 1
    }
    
    // Header
    func tableView(_ tableView: UITableView, viewForHeaderInSection section: Int) -> UIView? {
        let v = UIView()
        let header = HeaderOrderDetail()
        v.addSubview(header)
        header.fillSuperview()
        if section < self.listHeader.count {
            header.lbTitle.text = self.listHeader[section].uppercased()
            v.backgroundColor = AppColor.gray_65_65_65
        }
        
        return v
    }
    
    func tableView(_ tableView: UITableView, heightForHeaderInSection section: Int) -> CGFloat {
        // comment show header only one
        if section >= self.listHeader.count || section == 0 {
            return 0
        }
        return 47.5
    }
}


extension MyBuyDetailViewController: MyBuyImageCellDelegate {
    func btnCancelTapped() {
        if isSaler {
            btnSaleCancelBuy()
        } else {
            PopUpHelper.shared.showYesNoQuestionHaveAds(question: "Bạn chắc chắn muốn huỷ giao dịch", completionYes: {
                self.presenter?.changedStatusOrder(status: OrderStatusKey.buyerCancel, id: self.orderId)
            }) {
                print("No")
            }
        }
        
    }
    
    @IBAction func btnDoneTapped() {
        self.presenter?.changedStatusOrder(status: OrderStatusKey.done, id: self.orderId)
    }
    
    @IBAction func btnNotArrivedTapped() {
        self.presenter?.changedStatusOrder(status: OrderStatusKey.orderNotYetArrived, id: self.orderId)
    }
    
    @IBAction func btnRatingTapped() {
        // fix me
//        PopUpHelper.shared.showMessageHaveAds(message: "Đang đợi API")
        guard let accountID = order?.accountIDSaler  else { return }
        presenter?.postRating(point: vRating.number, accountID: accountID, isBuyer: false, orderID: orderId)
    }
    
    @IBAction func btnRatingSalerTapped() {
        // fix me
//        PopUpHelper.shared.showMessageHaveAds(message: "Đang đợi API 111")
        guard let accountID = order?.accountIDBuyer  else {return }
        presenter?.postRating(point: vRating.number, accountID: accountID, isBuyer: false, orderID: orderId)
    }
    
    
    @IBAction func btnSaleAcceptBuy() {
        PopUpHelper.shared.showMessageHaveAds(message: "Bạn đã đồng ý bán sản phẩm")
        self.presenter?.changedStatusOrderSaler(status: OrderStatusKey.waitDelivery, id: self.orderId)
    }
    
    @IBAction func btnSaleCancelBuy() {
        PopUpHelper.shared.showYesNoQuestionHaveAds(question: "Bạn có chắc chắn từ chối bán cho khách này không?", completionYes: {
            self.presenter?.changedStatusOrderSaler(status: OrderStatusKey.sellerCancel, id: self.orderId)
        }) {
            
        }
        
    }
    
    @IBAction func btnSaleReceivedMoney() {
        self.presenter?.changedStatusOrderSaler(status: OrderStatusKey.done, id: self.orderId)
    }
    
}
